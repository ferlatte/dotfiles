#! /bin/bash

set -eu -o pipefail

function inpath {
    which $1 > /dev/null
}

pushd ~/dotfiles > /dev/null
git pull
stow [a-z]*
popd > /dev/null

pushd ~/.bash_it > /dev/null
git pull
popd > /dev/null

bash-it-configure

brewup

if inpath pyenv; then
    pyenv rehash
fi

if inpath vagrant; then
    vagrant plugin update
fi

# These end up in ~/src/go/bin
# go and Cylance don't get along: https://github.com/golang/go/issues/18171
# figure out what to do about this later.
# go get -u github.com/nsf/gocode
# go get -u github.com/golang/lint/golint
# go get -u mvdan.cc/sh/cmd/shfmt

# Update arcanist
if [[ -d $HOME/src/arcanist ]]; then
    pushd $HOME/src/arcanist
    git pull
    popd
    pushd $HOME/src/libphutil
    git pull
    popd
fi

open /Applications/Emacs.app

# HACK: Really, we should use e --eval to poll to see when Emacs is ready.
sleep 10

# If you don't refresh package before updating prelude, prelude-update
# doesn't appear to reliably work.
# EMACS Prelude does it's own git update, followed by a ton of stuff
e --eval \
  '(package-refresh-contents)' \
  '(prelude-update)'


readonly chromeupdater=/Library/Google/GoogleSoftwareUpdate/GoogleSoftwareUpdate.bundle/Contents/Resources/GoogleSoftwareUpdateAgent.app/Contents/MacOS/GoogleSoftwareUpdateAgent

if [[ -x $chromeupdater ]]; then
    echo -n "Requesting Chrome update... "
    $chromeupdater -runMode oneshot -userInitiated YES
    echo "done."
fi
